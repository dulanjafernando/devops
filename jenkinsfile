pipeline {
    agent any

    environment {
        // ---------------- GIT ----------------
        GIT_REPO        = "https://github.com/dulanjafernando/devops.git"
        GIT_BRANCH     = "main"
        GIT_CREDENTIAL = "github-token"

        // ------------- DOCKER HUB -------------
        DOCKER_CREDENTIALS_ID = "dockerhub"
        DOCKER_REPO           = "dulanjah/devops_engineering"

        BACKEND_IMAGE  = "${DOCKER_REPO}:backend"
        FRONTEND_IMAGE = "${DOCKER_REPO}:frontend"

        // ------------- AWS / TERRAFORM --------
        AWS_CREDENTIALS_ID = "aws-credentials"  // This should match your Jenkins credential ID
    }

    stages {

        stage('Clone Repository') {
            steps {
                git branch: "${GIT_BRANCH}",
                    url: "${GIT_REPO}",
                    credentialsId: "${GIT_CREDENTIAL}"
            }
        }

        stage('Build Backend Image') {
            steps {
                dir('docker-project-main/backend') {
                    sh """
                        docker build -t ${BACKEND_IMAGE} .
                    """
                }
            }
        }

        stage('Build Frontend Image') {
            steps {
                dir('docker-project-main/frontend') {
                    sh """
                        docker build -t ${FRONTEND_IMAGE} .
                    """
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: DOCKER_CREDENTIALS_ID,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh """
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${BACKEND_IMAGE}
                        docker push ${FRONTEND_IMAGE}
                        docker logout
                    """
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform_devops/terrafor-ec2') {
                    withCredentials([
                        aws(
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY',
                            credentialsId: "${AWS_CREDENTIALS_ID}"  // Using the environment variable
                        )
                    ]) {
                        sh '''
                            # AWS credentials are already set by Jenkins
                            terraform init
                        '''
                    }
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('terraform_devops/terrafor-ec2') {
                    withCredentials([
                        aws(
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY',
                            credentialsId: "${AWS_CREDENTIALS_ID}"  // Using the environment variable
                        )
                    ]) {
                        sh '''
                            # AWS credentials are already set by Jenkins
                            terraform plan
                        '''
                    }
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform_devops/terrafor-ec2') {
                    withCredentials([
                        aws(
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY',
                            credentialsId: "${AWS_CREDENTIALS_ID}"  // Using the environment variable
                        )
                    ]) {
                        sh '''
                            # AWS credentials are already set by Jenkins
                            terraform apply -auto-approve
                        '''
                    }
                }
            }
        }

        stage('Cleanup Workspace') {
            steps {
                cleanWs()
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline completed successfully"
        }
        failure {
            echo "❌ Pipeline failed – check logs above"
        }
    }
}
